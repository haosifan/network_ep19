---
title: "data_aquisition_twitter"
author: "Stefan Haußner"
date: "12 Juli 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rtweet)
library(openxlsx)
library(httpuv)
```


```{r}
get_token()

lookup_users("s_haussner")
```

# Einlesen der Daten

Liste aller MEPs (Stand 12.07.2019) mit Parteizugehörigkeit, Land und Fraktion und dazugehörigem Twitternamen.

Link user_ids to screen_name in meps_list_withtwitter.

```{r}
lookup_userids <- function(user_name) {
  user_info <- rtweet::lookup_users(user_name, parse = TRUE)
  return(user_info$user_id)
}

meps_full_list <- read.csv2("../data/meps_full_list.csv") %>% tbl_df()
#meps_full_list

meps_list_withtwitter <- meps_full_list %>% 
  filter(!is.na(twitter_name)) %>% 
  mutate(twitter_id = lookup_userids(as.character(twitter_name)))
meps_list_withtwitter

meps_full_list %>% 
  filter(!is.na(twitter_name)) %>% 
  head() %>% 
  mutate(twitter_id = lookup_userids(as.character(twitter_name))) %>% 
  select(twitter_name, twitter_id)
```

Obtain edge list of MEP-network:

First get all friends of all MEPs (with twitter). Afterwards filter where the user_id of the friends-set is part of the MEP-set.
Result is an edge list, which can be used for making a directed network.

```{r}
allfriends <- rtweet::get_friends(users = meps_list_withtwitter$twitter_id, retryonratelimit = TRUE)

edge_list <- allfriends %>% 
  filter(user_id %in% meps_list_withtwitter$twitter_id)

write_csv2(x = allfriends, path = "../data/allfriends.csv")
write_csv2(x = edge_list, path = "../data/edge_list.csv")
write_csv2(x = meps_full_list, "../data/meps_full_list.csv")
write_csv2(x = meps_list_withtwitter, path = "../data/meps_twitter.csv")
```


In the first round `r length(unique(edge_list$user))` (539) MEPs resulted as start nodes and `r length(unique(edge_list$user_id` (619) as end node.

Which MEPs are still missing in as start nodes?
 * Can be because of protected profiles
 * data retrieval error
 * the MEP is not following anyone of their colleagues (or not anyone at all)


MEPs with Twitter, but not at all in the edge_list are:

Michael Gahler - protected
KingaGál - wrong twitter account, deleted for next data retrieval rounds
Hannes Heide - unclear if correct account
Krysztof Jurgiel - not following anybody of his/her colleagues (!)
Sylvia LIMMER - protected account
Aušra MALDEIKIENE - not following anybody of his/her colleagues (!)
Giuseppe MILAZZO - not following anybody of his/her colleagues (!)
Marlene MORTLER - Fake account - deleted for next data retrieval rounds
Sandra PEREIRA - data retrieval error
Drago<U+0219> PÎSLARU - not following anybody of his/her colleagues (!)
Rovana PLUMB - not following anybody of her colleagues


# provisional step

Adjust the MEP-info on these cases that are part of the edge list, either as start or as end-node.

```{r}

d_mep_twitter_adj <- d_mep_twitter %>% 
  filter(twitter_id %in% edge_list$user_id)
```


